import "runtime";

Fruit :: enum {
    Mango,
    Kiwi,
    Watermelon,
    Dragonfruit,
    Pear,
    Apple
}

Vector3 :: struct {
    x, y, z: float;
}

EntityKind :: enum {
    Wall,
    Monster,
    Human,
}

Entity :: struct {
    kind:     EntityKind;
    position: Vector3;
    rotation: Vector3;
    dead:     bool;
}

main :: () {
    print("-------------------- Primitive types ----------------\n");
    {
        x: any = cast(u8)5;

        assert(x.type.kind == .Int);

        type := cast(*TypePrimitive) x.type;
        print("TypePrimitive = %", *type);
    }
    print("\n-------------------- Array type ----------------\n");
    {
        x: any = [1, 2, 3];

        assert(x.type.kind == .Array);

        type := cast(*TypeArray) x.type;
        print("TypeArray = %\n", *type);
        print("ElemType  = %\n", *type.elemType);
    }
    print("\n-------------------- Enum type ----------------\n");
    {
        x: any = Fruit.Watermelon;

        assert(x.type.kind == .Enum);

        type := cast(*TypeEnum) x.type;
        print("TypeEnum = %\n", *type);
        print("BackingType = %\n", *type.backingType);
    }
    print("\n-------------------- Struct type ----------------\n");
    {
        x: any = Entity{
            kind     = .Human,
            position = Vector3{3, 3, 3},
            rotation = Vector3{0, 0.5, 0},
            dead     = false,
        };

        assert(x.type.kind == .Struct);
        printStructType(cast(*TypeStruct) x.type);
    }
    print("\n-------------------- Changing types at runtime ----------------\n");
    {
        x: any = 5;
        print("%\n", *x.type);
        assert(x.type.kind == .Int);

        x = Vector3{1, 4, 9};
        assert(x.type.kind == .Struct);
        printStructType(cast(*TypeStruct) x.type);

        x = Entity{
            kind     = .Human,
            position = Vector3{3, 3, 3},
            rotation = Vector3{0, 0.5, 0},
            dead     = false,
        };
        assert(x.type.kind == .Struct);
        printStructType(cast(*TypeStruct) x.type);
    }
}

printStructType :: (structType: *TypeStruct) {
    print("% :: struct {\n", structType.head.name);
    for member in structType.members {
        print("\t%: %;\n", member.name, member.type.name);
    }
    print("}\n");
}